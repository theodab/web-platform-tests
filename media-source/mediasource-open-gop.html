<!DOCTYPE html>
<!-- Copyright Â© 2016 Chromium authors and World Wide Web Consortium, (Massachusetts Institute of Technology, ERCIM, Keio University, Beihang). -->
<html>
    <head>
        <title>Open GOP test cases.</title>
        <script src="/resources/testharness.js"></script>
        <script src="/resources/testharnessreport.js"></script>
        <script src="mediasource-util.js"></script>
    </head>
    <body>
        <div id="log"></div>
        <script>

          var subType = MediaSourceUtil.getSubType(MediaSourceUtil.VIDEO_ONLY_TYPE);
          if (subType == 'webm') {
            var manifestFilenameVideo = "webm/test-v-no-keyframe-cluster-manifest.json";

            mediasource_test(function(test, mediaElement, mediaSource) {
              mediaElement.addEventListener("error", test.unreached_func("Unexpected event 'error'"));
              MediaSourceUtil.fetchManifestAndData(test, manifestFilenameVideo, function(typeVideo, dataVideo)
              {
                  var sourceBufferVideo = mediaSource.addSourceBuffer(typeVideo);
                  sourceBufferVideo.timestampOffset = 0;
                  sourceBufferVideo.appendWindowEnd = 1;

                  test.expectEvent(sourceBufferVideo, "updateend");
                  sourceBufferVideo.appendBuffer(dataVideo);
                  test.waitForExpectedEvents(function() {
                      test.expectEvent(mediaElement, "playing");
                      mediaElement.play();
                      test.waitForExpectedEvents(function() {
                          test.done();
                      });
                  });
              });
            }, "Test support for webm clusters that do not start with a keyframe.");
          } else {
            var manifestFilenameVideoInit = "mp4/test-v-no-keyframe-segment-manifest-init.json";
            var manifestFilenameVideo = "mp4/test-v-no-keyframe-segment-manifest.json";

            mediasource_test(function(test, mediaElement, mediaSource) {
              mediaElement.addEventListener("error", test.unreached_func("Unexpected event 'error'"));
              MediaSourceUtil.fetchManifestAndData(test, manifestFilenameVideoInit, function(typeVideoInit, dataVideoInit)
              {
                  MediaSourceUtil.fetchManifestAndData(test, manifestFilenameVideo, function(typeVideo, dataVideo)
                  {
                      var sourceBufferVideo = mediaSource.addSourceBuffer(typeVideo);
                      sourceBufferVideo.timestampOffset = 0;
                      sourceBufferVideo.appendWindowEnd = 1;

                      test.expectEvent(sourceBufferVideo, "updateend");
                      sourceBufferVideo.appendBuffer(dataVideoInit);
                      test.waitForExpectedEvents(function()
                      {
                          test.expectEvent(sourceBufferVideo, "updateend");
                          sourceBufferVideo.appendBuffer(dataVideo);
                          test.waitForExpectedEvents(function() {
                              test.expectEvent(mediaElement, "playing");
                              mediaElement.play();
                              test.waitForExpectedEvents(function() {
                                  test.done();
                              });
                          });
                      });
                  });
              });
            }, "Test support for mp4 segments that do not start with a keyframe.");
          }

        </script>
    </body>
</html>
